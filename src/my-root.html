<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/sc-timeago/sc-timeago.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/nuxeo-elements/nuxeo-document.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/nuxeo-elements/widgets/nuxeo-file.html">
<link rel="import" href="add-folder.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-root">

    <template>

        <style include="iron-flex iron-flex-alignment">

        </style>

        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
                --button-text-color: #3F51B5;
                --button-background-color: white;
                --button-hover-text-color: #B3E5FC;
                --button-hover-background-color: #3F51B5;
            }
            .container {
                @apply(--layout-vertical);
                border: 2px solid #3F51B5;
                border-radius: 5px;
                background: no-repeat top center url("../images/folder-icon.png");
            }
            .sub-container {
                @apply(--layout-vertical);
            }
            .sub-container h3 {
                margin-bottom: 0.1em;
                margin-top: 0.1em;
                padding-left: 2ch;
                text-shadow: rgba(255,255,255,1) 1px 1px 2px;
            }
            .folder-title {
                text-align: center;
                font-size: 22px;
                font-weight: 700;
                text-shadow: rgba(255,255,255,1) 1px 1px 10px;
                padding-top: 1.8em;
            }
            .contents-text {
                text-align: center;
                font-size: 24px;
                font-weight: 100;
                padding-top: 4em;
                margin-bottom: 0;
            }
            .folder-list, .file-list {
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
                @apply(--layout-wrap);
            }
            .folders, .files {
                width: 20%;
                min-width: 130px;
                text-align: center;
                border: 1px solid #3F51B5;
                border-radius: 5px;
            }
            .folders {
                background: no-repeat top/40% url("../images/folder-icon.png") rgba(255, 255, 255, 0.1);
                padding-top: 5ch;
                margin-top: 0.5ch;
            }
            .folders:hover, .files:hover {
                border: 1px solid #B3E5FC;
                background-color: rgba(255, 255, 255, 0.1);
            }
            .files {
                padding-top: 1ch;
                padding-bottom: 1ch;
            }
            #file-title {
                border-top: 2px solid #3F51B5;
                margin-top: 1.5ch;
                padding-top: 0.5ch;
            }
            .title {
                text-align: center;
            }

            .title {
                font-weight: 500;
            }
            #title {
                text-transform: capitalize;
            }
            paper-dialog {
                padding-top: 2em;
            }
            paper-dialog a {
                text-decoration: none;
                color: #757575;
            }
        </style>

        <app-route
                route="{{route}}"
                pattern="/:view"
                data="{{routeData}}"
                tail="{{subroute}}"
                active="{{activeRoute}}"></app-route>

        <div class="container">
            <h1 class="folder-title"><span id="title"></span> Folder</h1>
            <nuxeo-resource auto id="nuxeo" path="{{_computePath(route.path)}}" response="{{docs}}"></nuxeo-resource>
            <div class="flex">
                <h2 class="contents-text">Contents</h2>
                <div class="sub-container">
                    <h3><span class="sub-title">Folders</span></h3>
                    <div class="folder-list">
                        <template is="dom-repeat" id="repeater" items="{{docs.entries}}"
                                  filter="isFolder" observe="facets">
                            <div class="folders title" id="{{item.path}}" on-tap="viewFolder">{{item.title}}</div>
                        </template>
                        <paper-button raised toggles class="new" on-tap="openContentAdder">ADD FOLDER</paper-button>
                    </div>
                    <h3 id="file-title"><span class="sub-title">Files</span></h3>
                    <div class="file-list">
                        <template is="dom-repeat" items="{{docs.entries}}"
                                  filter="isFile" observe="facets">
                            <div class="files title" on-tap="viewResource">{{item.title}}</div>
                        </template>
                        <nuxeo-file id="test" value="{{batch}}"></nuxeo-file>
                    </div>
                </div>
            </div>
        </div>

        <!--MODAL-->
        <paper-dialog id="contentAdder"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">

            <template is="dom-if" if="{{showDocumentUploader}}">
                <add-folder nuxeo-data="{{data}}"></add-folder>
            </template>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
            </div>
        </paper-dialog>

    </template>

    <script>

        Polymer({

            is: 'my-root',

            showDocumentUploader: false,

            properties: {
                data: {
                    type: Object,
                    observer: '_manageFolderPath'
                },
                batch: {
                    type: String,
                    observer: '_manageFilePath'
                }
            },

            ready: function() {
                this.$.nuxeo.setAttribute('on-response', 'handleResponse');
            },

            openContentAdder: function() {
                this.set('showDocumentUploader', true);
                this.$.contentAdder.open();
            },

            isFolder: function(entries) {
                return entries.facets.includes("Folderish");
            },

            isFile: function(entries) {
                return (!entries.facets.includes("Folderish"));
            },

            viewFolder: function(e) {
                let path = e.model.item.path.replace('/default-domain/workspaces/','');
                this.set('route.path', path)
            },

            viewResource: function(e) {
                console.log(e);
            },

            _computePath: function(path) {
                return 'path/default-domain/workspaces/'+ ((path) ? path + '/':'') + '@children';
            },

            _manageFolderPath: function(data) {
                let nuxeo = this.$.nuxeo,
                        path = nuxeo.path,
                        postPath = path.split('@')[0];
                nuxeo.setAttribute("data", data);
                nuxeo.setAttribute("path", postPath);
                nuxeo.post()
                        .then(function(result){
                            if(!result) {
                                alert("there was a problem creating your new folder");
                                return false;
                            } else {
                                nuxeo.setAttribute('path', path);
                                alert("your folder has been created")
                            }
                        });
                this.set('showDocumentUploader', false);
                this.$.contentAdder.close();
                nuxeo.removeAttribute('data');
            },
            _manageFilePath: function(data) {
                let nuxeo = this.$.nuxeo,
                        path = nuxeo.path,
                        postPath = path.split('@')[0],
                        nuxeoData = {
                            "entity-type": "document",
                            "name": "anything", //CHANGE SO USER CAN ADD MORE FIELDS
                            "properties": {
                                "file:content": data
                            },
                            "type": "File"
                        };
                nuxeoData = JSON.stringify(nuxeoData);
                nuxeo.setAttribute("path", postPath);
                nuxeo.setAttribute("data", nuxeoData);
                nuxeo.post()
                        .then(function(result){
                            console.log(result);
                            nuxeo.setAttribute('path', path);
                        })
            }
        });

    </script>

</dom-module>