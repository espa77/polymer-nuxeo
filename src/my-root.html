<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/sc-timeago/sc-timeago.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/nuxeo-elements/nuxeo-document.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="add-folder.html">
<link rel="import" href="add-file.html">
<link rel="import" href="file-viewer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-root">

    <template>

        <style include="iron-flex iron-flex-alignment">

        </style>

        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
                --button-text-color: #3F51B5;
                --button-background-color: white;
                --button-hover-text-color: #B3E5FC;
                --button-hover-background-color: #3F51B5;
            }
            #container {
                @apply(--layout-vertical);
                border: 2px solid #3F51B5;
                border-radius: 5px;
                background: no-repeat top center url("../images/folder-icon.png");
            }
            .sub-container {
                @apply(--layout-vertical);
            }
            .sub-container h3 {
                margin-bottom: 0.1em;
                margin-top: 0.1em;
                padding-left: 2ch;
                text-shadow: rgba(255,255,255,1) 1px 1px 2px;
            }
            .folder-title {
                text-align: center;
                font-size: 22px;
                font-weight: 700;
                text-shadow: rgba(255,255,255,1) 1px 1px 10px;
                padding-top: 1.8em;
            }
            #contents-text {
                text-align: center;
                font-size: 24px;
                font-weight: 100;
                padding-top: 4em;
                margin-bottom: 0;
            }
            .folder-list, .file-list {
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
                @apply(--layout-wrap);
                padding-bottom: 1.5em;
            }
            .folders, .files {
                width: 20%;
                min-width: 130px;
                text-align: center;
                border: 1px solid transparent;
                border-radius: 5px;
            }
            .folders {
                background: no-repeat top/40% url("../images/folder-icon.png") rgba(255, 255, 255, 0.05);
                padding-top: 5ch;
                margin-top: 0.5ch;
            }
            .folders:hover, .files:hover {
                border: 1px solid #3F51B5;
                background-color: rgba(255, 255, 255, 0.05);
            }
            .files {
                padding-top: 1ch;
                padding-bottom: 1ch;
            }
            #file-title {
                border-top: 2px solid #3F51B5;
                padding-top: 0.5ch;
            }
            .title {
                text-align: center;
                font-weight: 500;
                margin-bottom: 0.5em;
                padding-bottom: 1em;
            }
            .new {
                background: #1976D2;
                color: #efefef
            }
            #routeFolderTitle {
                text-transform: capitalize;
            }
            paper-dialog {
                padding-top: 2em;
            }
            paper-dialog a {
                text-decoration: none;
                color: #757575;
            }
            #folderAdder, #documentAdder {
                left: 35%;
            }
            #filePreview {
                max-width: 80%;
                position: fixed;
                left: 45%;
                top: 15vh;
            }
            #contentsNumber {
                justify-content: center;
                flex-direction: row;
            }
            @media screen and (max-width: 640px){
                #folderAdder, #documentAdder {
                    left: inherit;
                }
                #filePreview {
                    max-width: 95%;
                    left: 15vw;
                }
            }
        </style>

        <app-route
                route="{{route}}"
                pattern="/:view"
                data="{{routeData}}"
                tail="{{subroute}}"
                active="{{activeRoute}}"></app-route>

        <nuxeo-resource auto id="nuxeo" path="{{_computePath(route.path)}}" response="{{docs}}" on-response="handleResponse"></nuxeo-resource>
        <div id="container">
            <h1 class="folder-title"><span id="routeFolderTitle">{{_computeName(route.path)}}</span> Folder</h1>
            <div class="flex">
                <h2 id="contents-text">Contents</h2>
                <h3 id="contentsNumber" style="display:none">There are {{results}} documents in this folder</h3>
                <div class="sub-container">
                    <h3><span class="sub-title">Folders</span></h3>
                    <div class="folder-list">
                        <template is="dom-repeat" id="repeater" items="{{docs.entries}}"
                                  filter="isFolder" observe="facets">
                            <div class="folders title" id="{{item.path}}" on-tap="viewFolder">{{item.title}}</div>
                        </template>
                        <paper-button raised class="new" on-tap="openFolderAdder">ADD FOLDER</paper-button>
                    </div>
                    <h3 id="file-title"><span class="sub-title">Documents</span></h3>
                    <div class="file-list">
                        <template is="dom-repeat" items="{{docs.entries}}"
                                  filter="isFile" observe="facets">
                            <div class="files title" id={{item.uid}} on-tap="viewResource">{{item.title}}</div>
                        </template>
                        <paper-button raised class="new" on-tap="openDocumentAdder">ADD DOCUMENT</paper-button>
                    </div>
                </div>
            </div>
        </div>

        <!--FOLDER MODAL-->
        <paper-dialog id="folderAdder"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">

            <template is="dom-if" if="{{showFolderUploader}}">
                <add-folder folder-data="{{data}}"></add-folder>
            </template>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
            </div>
        </paper-dialog>

        <!--DOCUMENT MODAL-->
        <paper-dialog id="documentAdder"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">

            <template is="dom-if" if="{{showDocumentUploader}}">
                <add-file document-data="{{data}}"></add-file>
            </template>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
            </div>
        </paper-dialog>

        <!--FILE PREVIEW-->
        <paper-dialog id="filePreview"
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation"
                      on-iron-overlay-closed="_clearProps">
            <template is="dom-if" if="{{showPreview}}">
                <file-viewer uid="{{uid}}"></file-viewer>
                <div class="buttons">
                    <paper-button dialog-dismiss>Close</paper-button>
                </div>
            </template>
        </paper-dialog>

    </template>

    <script>

        Polymer({

            is: 'my-root',

            showDocumentUploader: false,
            showFolderUploader: false,
            showPreview: false,

            properties: {
                data: {
                    type: Object,
                    observer: '_manageUploadPath'
                },
                results: {
                    type: String
                },
                uid: {
                    type: String,
                    observer: '_fileViewPath'
                }
            },

            handleResponse: function(success, responseObject) {
                if(success.returnValue) {
                    if (success.srcElement.method === "post") {
                        if (success.detail.response.type == "Folder") {
                            alert("your folder has been created");
                            this.set('showFolderUploader', false);
                            this.$.folderAdder.close();
                        } else {
                            alert("your document has been created");
                            this.set('showDocumentUploader', false);
                            this.$.documentAdder.close();
                        }
                    }
                    if (success.srcElement.method === "get") {
                        let count = responseObject.response.resultsCount;
                        if (count > 1) {
                            this.set('results', count);
                            this.$.contentsNumber.style.display = "flex";
                        } else {
                            this.$.contentsNumber.style.display = "none";
                        }
                    }
                } else {
                    alert("please check your connection to nuxeo")
                }
            },

            filePreview: function(event, object) {
                if (object.response.type === "Picture" || object.response.type === "File") {
                    this.imagePreview(object);
                }
                if (object.response.type === "Note") {
                    this.notePreview(object);
                }
            },

            imagePreview: function(object) {
                let fileData = object.response.properties["file:content"].data,
                    mimeType = object.response.properties["file:content"]["mime-type"],
                    fileName = object.response.properties["file:content"].name;
                this.set('fileDataPath', fileData);
                this.set('mimeType', mimeType);
                this.set('fileName', fileName);
            },

            notePreview: function(object) {
                let note = object.response.properties["note:note"],
                    mimeType = object.response.properties["note:mime_type"],
                    noteName = object.response.properties["dc:title"];
                this.set('note', note);
                this.set('mimeType', mimeType);
                this.set('fileName', noteName);
            },

            openFolderAdder: function() {
                this.set('showFolderUploader', true);
                this.$.folderAdder.open();
            },

            openDocumentAdder: function() {
                this.set('showDocumentUploader', true);
                this.$.documentAdder.open();
            },

            isFolder: function(entries) {
                return entries.facets.includes("Folderish");
            },

            isFile: function(entries) {
                return (!entries.facets.includes("Folderish"));
            },

            viewFolder: function(e) {
                let path = e.model.item.path.replace('/default-domain/workspaces/','');
                this.set('route.path', path)
            },

            viewResource: function(e) {
                this.set('uid', "");
                this.set('uid', e.model.item.uid);
            },

            _fileViewPath: function(uid) {
                this.set('showPreview', true);
                this.$.filePreview.open();
            },

            _computePath: function(path) {
                return 'path/default-domain/workspaces/' + ((path) ? path + '/' : '') + '@children';
            },
            _computeName: function(path) {
                if (path === "") {
                    return "root";
                }
                path = path.replace('/', '');
                return path;
            },

            _manageUploadPath: function(data) {
                let nuxeo = this.$.nuxeo,
                        path = nuxeo.path,
                        postPath = path.split('@')[0];
                nuxeo.setAttribute("data", data);
                nuxeo.setAttribute("path", postPath);
                nuxeo.post();
                nuxeo.removeAttribute('data');
            },

            _createEmbed: function() {
                this.$.filecontent.src = this.fileDataPath;
            },

            _clearProps: function() {
                this.set('fileDataPath', "");
                this.set('mimeType', "");
                this.set('fileName', "");
                this.set('note', "");
            }
        });

    </script>

</dom-module>