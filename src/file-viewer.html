<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/nuxeo-elements/nuxeo-document.html">

<dom-module id="file-viewer">

    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
            h3 {
                margin-bottom: 0;
            }
        </style>
        <head>File Viewer Component</head>
        <body>
            <nuxeo-document auto doc-id="{{uid}}" on-response="filePreview"></nuxeo-document>
            <h3>{{fileName}}</h3>
            <div id="container">
                <embed id="filecontent" type="{{mimeType}}" width="88%"></embed>
            </div>
        </body>
    </template>

    <script>

        Polymer({

            is: 'file-viewer',

            properties: {

                uid: {
                    type: String
                },
                fileDataPath: {
                    type: String,
                    observer: '_createEmbed'
                },
                mimeType: {
                    type: String
                },
                fileName: {
                    type: String
                },
                note: {
                    type: String,
                    observer: '_appendNote'
                }
            },

            handleResponse: function(success, responseObject) {
                if(success.returnValue) {
                    if (success.srcElement.method === "post") {
                        if (success.detail.response.type == "Folder") {
                            alert("your folder has been created");
                            this.set('showFolderUploader', false);
                            this.$.folderAdder.close();
                        } else {
                            alert("your document has been created");
                            this.set('showDocumentUploader', false);
                            this.$.documentAdder.close();
                        }
                    }
                    if (success.srcElement.method === "get") {
                        let count = responseObject.response.resultsCount;
                        if (count > 1) {
                            this.set('results', count);
                            this.$.contentsNumber.style.display = "flex";
                        } else {
                            this.$.contentsNumber.style.display = "none";
                        }
                    }
                } else {
                    alert("please check your connection to nuxeo")
                }
            },

            filePreview: function(event, object) {
                if (object.response.type === "Picture" || object.response.type === "File") {
                    this.imagePreview(object);
                }
                if (object.response.type === "Note") {
                    this.notePreview(object);
                }
            },

            imagePreview: function(object) {
                let fileData = object.response.properties["file:content"].data,
                        mimeType = object.response.properties["file:content"]["mime-type"],
                        fileName = object.response.properties["file:content"].name;
                this.set('fileDataPath', fileData);
                this.set('mimeType', mimeType);
                this.set('fileName', fileName);
            },

            notePreview: function(object) {
                let note = object.response.properties["note:note"],
                        mimeType = object.response.properties["note:mime_type"],
                        noteName = object.response.properties["dc:title"];
                this.set('note', note);
                this.set('mimeType', mimeType);
                this.set('fileName', noteName);
            },

            _createEmbed: function() {
                this.$.filecontent.style.display = 'block';
                this.$.filecontent.src = this.fileDataPath;
            },

            _appendNote: function() {
                this.$.filecontent.style.display = 'none';
                this.$.container.innerHTML = this.note;
            },

            _clearProps: function() {
                this.set('fileDataPath', "");
                this.set('mimeType', "");
                this.set('fileName', "");
                this.set('note', "");
            }
        });

    </script>

</dom-module>